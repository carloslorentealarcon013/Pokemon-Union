// ============================================
// 1Ô∏è‚É£ CONTENEDORES - Elementos del HTML
// ============================================
const pokedexTimeline = document.getElementById('pokedex-timeline');
const descriptionText = document.getElementById('description-text');

// ============================================
// 2Ô∏è‚É£ COLORES POR TIPO
// ============================================
const tipoColores = {
    fire: "#F08030",
    water: "#6890F0",
    grass: "#78C850",
    electric: "#F8D030",
    bug: "#A8B820",
    normal: "#A8A878",
    poison: "#A040A0",
    ground: "#E0C068",
    fairy: "#EE99AC",
    fighting: "#C03028",
    psychic: "#F85888",
    rock: "#B8A038",
    ghost: "#705898",
    ice: "#98D8D8",
    dragon: "#7038F8",
    dark: "#705848",
    steel: "#B8B8D0",
    flying: "#A890F0"
};

// ============================================
// 3Ô∏è‚É£ FUNCI√ìN: Obtener color de un tipo
// ============================================
function tipoColor(tipo) {
    return tipoColores[tipo] || "#A8A878";
}

// ============================================
// 4Ô∏è‚É£ FUNCI√ìN: Traer UN Pok√©mon de la API
// ============================================
async function fetchPokemon(name) {
    try {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${name}`);
        const data = await res.json();
        return data;
    } catch (error) {
        console.log('Error trayendo Pok√©mon:', error);
        return null;
    }
}

// ============================================
// 5Ô∏è‚É£ FUNCI√ìN: Traer descripci√≥n del Pok√©mon
// ============================================
async function fetchPokemonDescription(pokemon) {
    const name = typeof pokemon === 'string' ? pokemon : pokemon.name;
    
    // Frases cortas caracter√≠sticas para cada Pok√©mon
    const descriptions = {
        'bulbasaur': 'Semilla en su espalda',
        'ivysaur': 'Brote floreciente',
        'venusaur': 'Flor gigante',
        'charmander': 'Cola de fuego',
        'charmeleon': 'Llamas intensas',
        'charizard': 'Drag√≥n de fuego',
        'psyduck': 'Siempre confundido',
        'squirtle': 'Tortuguita acu√°tica',
        'wartortle': 'Cola peluda',
        'blastoise': 'Ca√±ones de agua',
        'pikachu': 'Rat√≥n el√©ctrico',
        'raichu': 'Electricidad avanzada',
        'abra': 'Teleportaci√≥n constante',
        'kadabra': 'Poderes ps√≠quicos',
        'alakazam': 'Inteligencia superior',
        'gastly': 'Nube de gas',
        'haunter': 'Fantasma flotante',
        'gengar': 'Sombra traviesa',
        'lerxor': 'Poder el√©ctrico misterioso',
        'shainx': 'Cachorro brillante',
        'jigglypuff': 'Canto hipn√≥tico',
        'shinx': 'Cachorro el√©ctrico',
        'luxio': 'Garra brillante',
        'luxray': 'Vista de rayos X'
    };
    
    return descriptions[name] || 'Pok√©mon √∫nico';
}

// ============================================
// 6Ô∏è‚É£ FUNCI√ìN: Traer datos de la especie
// ============================================
async function fetchPokemonSpecies(name) {
    try {
        const res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${name}`);
        const data = await res.json();
        return data;
    } catch (error) {
        console.log('Error trayendo especie:', error);
        return null;
    }
}

// ============================================
// 7Ô∏è‚É£ FUNCI√ìN: Mostrar una l√≠nea de evoluci√≥n
// ============================================
async function mostrarLineaEvolucion(evolutionChain) {
    const evolutionLineDiv = document.createElement('div');
    evolutionLineDiv.classList.add('evolution-line');

    for (let i = 0; i < evolutionChain.length; i++) {
        const pokemon = evolutionChain[i];
        const description = await fetchPokemonDescription(pokemon);

        const pokemonCard = document.createElement('div');
        pokemonCard.classList.add('pokemon-card');
        
        // Hacer clickeable
        pokemonCard.style.cursor = 'pointer';
        pokemonCard.onclick = () => abrirDetallesPokemon(pokemon);
        
        // Est√≠lo especial para Shainx, Lerxor y l√≠neas personalizadas peque√±as
        let imgStyle = '';
        if (pokemon.name === 'shainx') {
            imgStyle = 'style="width: 90px; height: 90px;"';
        } else if (pokemon.name === 'lerxor') {
            imgStyle = 'style="width: 110px; height: 110px;"';
        } else if (
            pokemon.name === 'flamgor' ||
            pokemon.name === 'flamaser' ||
            pokemon.name === 'magmaboar' ||
            pokemon.name === 'sturppied' ||
            pokemon.name === 'stremeflor' ||
            pokemon.name === 'reyppied'
        ) {
            imgStyle = 'style="width: 90px; height: 90px;"';
        }
        
        pokemonCard.innerHTML = `
            <div style="text-align: center; margin-bottom: 10px;"><h4 style="margin: 0;">${pokemon.name.toUpperCase()}</h4><p style="font-size: 0.85em; color: #666; margin: 5px 0 0 0;">#${String(pokemon.id).padStart(3, '0')}</p></div>
            <div class="img-container">
                <img src="${pokemon.sprites.front_default}" alt="${pokemon.name}" ${imgStyle}>
            </div>
            <div class="types">
                ${pokemon.types
                    .map(t => 
                        `<span style="background-color:${tipoColor(t.type.name)}">${t.type.name.toUpperCase()}</span>`
                    )
                    .join('')}
            </div>
        `;
        
        evolutionLineDiv.appendChild(pokemonCard);

        if (i < evolutionChain.length - 1) {
            const arrowDiv = document.createElement('div');
            arrowDiv.classList.add('arrow');
            arrowDiv.innerText = '‚Üí';
            evolutionLineDiv.appendChild(arrowDiv);
        }
    }

    pokedexTimeline.appendChild(evolutionLineDiv);
    
    const separator = document.createElement('div');
    separator.classList.add('separator');
    pokedexTimeline.appendChild(separator);
}

// ============================================
// 8Ô∏è‚É£ FUNCI√ìN: Cargar todos los Pok√©mon
// ============================================
async function cargarPokemons() {
    console.log('‚è≥ Cargando Pok√©mon...');

    // PRIMERA L√çNEA: Sturppied ‚Üí Stremeflor ‚Üí Reyppied
    const sturppied = {
        id: 1,
        name: 'sturppied',
        height: 7,
        weight: 30,
        sprites: {
            front_default: '../images_pokemon/Sturppied.png',
            other: {
                'official-artwork': {
                    front_default: '../images_pokemon/Sturppied2k.png'
                }
            }
        },
        types: [
            { type: { name: 'grass' } }
        ],
        stats: [
            { stat: { name: 'hp' }, base_stat: 45 },
            { stat: { name: 'attack' }, base_stat: 45 },
            { stat: { name: 'defense' }, base_stat: 60 },
            { stat: { name: 'special-attack' }, base_stat: 45 },
            { stat: { name: 'special-defense' }, base_stat: 60 },
            { stat: { name: 'speed' }, base_stat: 63 }
        ],
        abilities: [
            { ability: { name: 'overgrow' }, is_hidden: false }
        ],
        base_experience: 64
    };
    const stremeflor = {
        id: 2,
        name: 'stremeflor',
        height: 10,
        weight: 80,
        sprites: {
            front_default: '../images_pokemon/Strinkflor.png',
            other: {
                'official-artwork': {
                    front_default: '../images_pokemon/Strinkflor2k.png'
                }
            }
        },
        types: [
            { type: { name: 'grass' } }
        ],
        stats: [
            { stat: { name: 'hp' }, base_stat: 65 },
            { stat: { name: 'attack' }, base_stat: 65 },
            { stat: { name: 'defense' }, base_stat: 80 },
            { stat: { name: 'special-attack' }, base_stat: 55 },
            { stat: { name: 'special-defense' }, base_stat: 75 },
            { stat: { name: 'speed' }, base_stat: 85 }
        ],
        abilities: [
            { ability: { name: 'overgrow' }, is_hidden: false }
        ],
        base_experience: 137
    };
    const reyppied = {
        id: 3,
        name: 'reyppied',
        height: 20,
        weight: 200,
        sprites: {
            front_default: '../images_pokemon/Reylour.png',
            other: {
                'official-artwork': {
                    front_default: '../images_pokemon/Reylour2k.png'
                }
            }
        },
        types: [
            { type: { name: 'grass' } }
        ],
        stats: [
            { stat: { name: 'hp' }, base_stat: 75 },
            { stat: { name: 'attack' }, base_stat: 75 },
            { stat: { name: 'defense' }, base_stat: 100 },
            { stat: { name: 'special-attack' }, base_stat: 75 },
            { stat: { name: 'special-defense' }, base_stat: 100 },
            { stat: { name: 'speed' }, base_stat: 113 }
        ],
        abilities: [
            { ability: { name: 'overgrow' }, is_hidden: false }
        ],
        base_experience: 236
    };
    await mostrarLineaEvolucion([sturppied, stremeflor, reyppied]);

    // SEGUNDA L√çNEA: Flamgor ‚Üí Flamaser ‚Üí Magmaboar
    const flamgor = {
        id: 4,
        name: 'flamgor',
        height: 6,
        weight: 25,
        sprites: {
            front_default: '../images_pokemon/Flamgor.png',
            other: {
                'official-artwork': {
                    front_default: '../images_pokemon/Flamgor2k.png'
                }
            }
        },
        types: [
            { type: { name: 'fire' } }
        ],
        stats: [
            { stat: { name: 'hp' }, base_stat: 65 },
            { stat: { name: 'attack' }, base_stat: 58 },
            { stat: { name: 'defense' }, base_stat: 46 },
            { stat: { name: 'special-attack' }, base_stat: 45 },
            { stat: { name: 'special-defense' }, base_stat: 45 },
            { stat: { name: 'speed' }, base_stat: 45 }
        ],
        abilities: [
            { ability: { name: 'blaze' }, is_hidden: false }
        ],
        base_experience: 62
    };
    const flamaser = {
        id: 5,
        $150 }
        ],
        abilities: [
            { ability: { name: 'blaze' }, is_hidden: false }
        ],
        base_experience: 142
    };
    const magmaboar = {
        id: 6,
        $155 }
        ],
        abilities: [
            { ability: { name: 'blaze' }, is_hidden: false }
        ],
        base_experience: 270
    };
    await mostrarLineaEvolucion([flamgor, flamaser, magmaboar]);

    const psyduck = await fetchPokemon('psyduck');
    await mostrarLineaEvolucion([psyduck]);

    // CUARTA L√çNEA: Squirtle ‚Üí Wartortle ‚Üí Blastoise
    const squirtle = await fetchPokemon('squirtle');
    const wartortle = await fetchPokemon('wartortle');
    const blastoise = await fetchPokemon('blastoise');
    await mostrarLineaEvolucion([squirtle, wartortle, blastoise]);

    // QUINTA L√çNEA: Pikachu ‚Üí Raichu
    const pikachu = await fetchPokemon('pikachu');
    const raichu = await fetchPokemon('raichu');
    await mostrarLineaEvolucion([pikachu, raichu]);

    // SEXTA L√çNEA: Abra ‚Üí Kadabra ‚Üí Alakazam
    const abra = await fetchPokemon('abra');
    const kadabra = await fetchPokemon('kadabra');
    const alakazam = await fetchPokemon('alakazam');
    await mostrarLineaEvolucion([abra, kadabra, alakazam]);

    // S√âPTIMA L√çNEA: Gastly ‚Üí Haunter ‚Üí Gengar
    const gastly = await fetchPokemon('gastly');
    const haunter = await fetchPokemon('haunter');
    const gengar = await fetchPokemon('gengar');
    await mostrarLineaEvolucion([gastly, haunter, gengar]);

    // OCTAVA L√çNEA: Lerxor (Pok√©mon personalizado)
    const lerxor = {
        id: 999,
        name: 'lerxor',
        height: 15,
        weight: 450,
        sprites: {
            front_default: '../images_pokemon/Lerxor2k.png',
            other: {
                'official-artwork': {
                    front_default: '../images_pokemon/Lerxor-anime.png'
                }
            }
        },
        types: [
            { type: { name: 'electric' } },
            { type: { name: 'water' } }
        ],
        stats: [
            { stat: { name: 'hp' }, base_stat: 75 },
            { stat: { name: 'attack' }, base_stat: 87 },
            { stat: { name: 'defense' }, base_stat: 79 },
            { stat: { name: 'special-attack' }, base_stat: 80 },
            { stat: { name: 'special-defense' }, base_stat: 83 },
            { stat: { name: 'speed' }, base_stat: 85 }
        ],
        abilities: [
            { ability: { name: 'static' }, is_hidden: false }
        ]
    };
    await mostrarLineaEvolucion([lerxor]);

    // NOVENA L√çNEA: Solo Jigglypuff (sin evoluci√≥n)
    const jigglypuff = await fetchPokemon('jigglypuff');
    await mostrarLineaEvolucion([jigglypuff]);

    // D√âCIMA L√çNEA: Shainx ‚Üí Luxio ‚Üí Luxray
    // Shainx es un Pok√©mon personalizado basado en Shinx
    const shinxData = await fetchPokemon('shinx');
    const shainx = {
        id: shinxData.id,
        name: 'shainx',
        height: shinxData.height,
        weight: shinxData.weight,
        sprites: {
            front_default: '../images_pokemon/Shainx2k.png',
            other: {
                'official-artwork': {
                    front_default: '../images_pokemon/shainx-anime.png'
                }
            }
        },
        types: shinxData.types,
        stats: shinxData.stats,
        abilities: shinxData.abilities,
        base_experience: shinxData.base_experience
    };
    const luxio = await fetchPokemon('luxio');
    const luxray = await fetchPokemon('luxray');
    await mostrarLineaEvolucion([shainx, luxio, luxray]);

    console.log('‚úÖ Pok√©mon cargados!');
}

// ============================================
// 9Ô∏è‚É£ INICIAR TODO CUANDO LA P√ÅGINA CARGUE
// ============================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ P√°gina lista, iniciando carga...');
    cargarPokemons();
    
    // Cerrar modal al hacer click fuera del contenido (en el fondo oscuro)
    const modal = document.getElementById('pokemon-modal');
    modal.addEventListener('click', function(event) {
        if (event.target === modal) {
            cerrarModal();
        }
    });
});

// ============================================
// 1Ô∏è‚É£0Ô∏è‚É£ FUNCI√ìN: Abrir modal con detalles
// ============================================
async function abrirDetallesPokemon(pokemonData) {
    console.log('üîç Abriendo detalles de:', pokemonData);
    
    // Si es un objeto Pok√©mon custom, usarlo directamente
    const customPokemons = ['lerxor', 'shainx', 'sturppied', 'stremeflor', 'reyppied', 'flamgor', 'flamaser', 'magmaboar'];
    
    if (typeof pokemonData === 'object' && customPokemons.includes(pokemonData.name)) {
        // Para Shainx, necesitamos datos de especie de Shinx
        if (pokemonData.name === 'shainx') {
            const species = await fetchPokemonSpecies('shinx');
            llenarModal(pokemonData, species);
        } else {
            // Para otros Pok√©mon custom, no mostrar descripci√≥n
            llenarModal(pokemonData, null);
        }
        document.getElementById('pokemon-modal').style.display = 'block';
        document.body.style.overflow = 'hidden';
        return;
    }
    
    const pokemonName = typeof pokemonData === 'string' ? pokemonData : pokemonData.name;
    const pokemon = await fetchPokemon(pokemonName);
    const species = await fetchPokemonSpecies(pokemonName);
    
    if (!pokemon || !species) {
        console.error('Error cargando datos del Pok√©mon');
        return;
    }

    llenarModal(pokemon, species);
    document.getElementById('pokemon-modal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// ============================================
// 1Ô∏è‚É£1Ô∏è‚É£ FUNCI√ìN: Llenar el modal con datos
// ============================================
function llenarModal(pokemon, species) {
    const imgUrl = pokemon.sprites.other['official-artwork'].front_default || 
        pokemon.sprites.front_default;
    
    document.getElementById('modal-pokemon-img').src = imgUrl;

    const tipo = pokemon.types[0].type.name;
    
    // Para Pok√©mon custom como Lerxor
    if (!species) {
        document.getElementById('modal-intro-text').textContent = 
            `${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)} es un Pok√©mon misterioso de tipo ${tipo.toUpperCase()}.`;
    } else {
        const generacion = species.generation.name.replace('generation-', 'Generaci√≥n ').replace('generation', 'Generaci√≥n');
        document.getElementById('modal-intro-text').textContent = 
            `${pokemon.name.charAt(0).toUpperCase() + pokemon.name.slice(1)} es un Pok√©mon de tipo ${tipo.toUpperCase()} introducido en ${generacion}.`;
    }

    document.getElementById('modal-number').textContent = 
        String(pokemon.id).padStart(3, '0');
    
    document.getElementById('modal-types').innerHTML = 
        pokemon.types.map(t => 
            `<span style="background-color:${tipoColor(t.type.name)}; padding:5px 10px; border-radius:5px; color:white;">${t.type.name.toUpperCase()}</span>`
        ).join(' ');

    document.getElementById('modal-species').textContent = 
        species ? (species.genera.find(g => g.language.name === 'en')?.genus || 'Unknown') : 'Pok√©mon Personalizado';

    document.getElementById('modal-height').textContent = 
        `${pokemon.height / 10} m`;

    document.getElementById('modal-weight').textContent = 
        `${pokemon.weight / 10} kg`;

    const abilities = pokemon.abilities
        .map(a => {
            const hidden = a.is_hidden ? ' (Oculta)' : '';
            return a.ability.name.charAt(0).toUpperCase() + a.ability.name.slice(1) + hidden;
        })
        .join(', ');
    document.getElementById('modal-abilities').textContent = abilities;

    document.getElementById('modal-ev-yield').textContent = 
        pokemon.stats.map(s => `${s.base_stat} ${s.stat.name}`).join(', ') || 'None';
    
    document.getElementById('modal-catch-rate').textContent = 
        species ? species.capture_rate + '%' : 'Desconocida';
    
    document.getElementById('modal-friendship').textContent = 
        species ? (species.base_happiness || 'Desconocida') : 'Desconocida';
    
    document.getElementById('modal-base-exp').textContent = 
        pokemon.base_experience || 'Desconocida';
    
    document.getElementById('modal-growth-rate').textContent = 
        species ? species.growth_rate.name.replace('-', ' ').charAt(0).toUpperCase() + species.growth_rate.name.replace('-', ' ').slice(1) : 'Desconocida';

    document.getElementById('modal-egg-groups').textContent = 
        species ? species.egg_groups.map(g => g.name.toUpperCase()).join(', ') : 'Desconocida';
    
    if (species) {
        const maleFemaleRatio = species.gender_rate;
        let genderText = 'Sin g√©nero';
        if (maleFemaleRatio !== -1) {
            const femalePercent = (maleFemaleRatio / 8) * 100;
            const malePercent = 100 - femalePercent;
            genderText = `${malePercent.toFixed(1)}% Macho / ${femalePercent.toFixed(1)}% Hembra`;
        }
        document.getElementById('modal-gender').textContent = genderText;
        
        document.getElementById('modal-egg-cycles').textContent = 
            `${species.hatch_counter} ciclos`;
    } else {
        document.getElementById('modal-gender').textContent = 'Desconocida';
        document.getElementById('modal-egg-cycles').textContent = 'Desconocida';
    }

    llenarStats(pokemon);
}

// ============================================
// 1Ô∏è‚É£2Ô∏è‚É£ FUNCI√ìN: Llenar las estad√≠sticas
// ============================================
function llenarStats(pokemon) {
    const statsContainer = document.getElementById('modal-stats');
    statsContainer.innerHTML = '';

    let totalStats = 0;

    pokemon.stats.forEach(stat => {
        totalStats += stat.base_stat;
        
        const statRow = document.createElement('div');
        statRow.classList.add('stat-row');
        
        const percentage = (stat.base_stat / 255) * 100;
        
        statRow.innerHTML = `
            <div class="stat-name">${abreviarStat(stat.stat.name)}</div>
            <div class="stat-bar-container">
                <div class="stat-bar" style="width:${percentage}%; background: ${getColorStat(stat.base_stat)};">
                    ${stat.base_stat}
                </div>
            </div>
        `;
        
        statsContainer.appendChild(statRow);
    });

    const totalRow = document.createElement('div');
    totalRow.classList.add('stat-row');
    totalRow.innerHTML = `
        <div class="stat-name" style="font-size: 1.1em;"><strong>TOTAL</strong></div>
        <div></div>
        <div class="stat-value" style="font-size: 1.1em;"><strong>${totalStats}</strong></div>
    `;
    statsContainer.appendChild(totalRow);
}

// ============================================
// 1Ô∏è‚É£3Ô∏è‚É£ FUNCI√ìN: Abreviar nombre de stat
// ============================================
function abreviarStat(statName) {
    const name = statName.toLowerCase();
    const abreviaturas = {
        'hp': 'PS',
        'attack': 'Atq',
        'defense': 'Def',
        'special-attack': 'Atq. Esp',
        'sp. atk': 'Atq. Esp',
        'sp-atk': 'Atq. Esp',
        'special-defense': 'Def. Esp',
        'sp. def': 'Def. Esp',
        'sp-def': 'Def. Esp',
        'speed': 'Vel'
    };
    return abreviaturas[name] || name;
}

// ============================================
// 1Ô∏è‚É£4Ô∏è‚É£ FUNCI√ìN: Color seg√∫n valor de stat
// ============================================
function getColorStat(value) {
    if (value >= 0 && value <= 25) return '#ff6b6b';        // Rojo
    if (value >= 26 && value <= 49) return '#ffa500';       // Naranja
    if (value >= 50 && value <= 89) return '#ffd700';       // Amarillo
    if (value >= 90 && value <= 115) return '#90ee90';      // Verde claro
    if (value >= 116 && value <= 139) return '#4caf50';     // Verde
    return '#1fabab';                                        // Celeste
}

// ============================================
// 1Ô∏è‚É£4Ô∏è‚É£ FUNCI√ìN: Cerrar modal
// ============================================
function cerrarModal() {
    document.getElementById('pokemon-modal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaurar scroll del fondo
}

// ============================================
// 1Ô∏è‚É£5Ô∏è‚É£ FUNCI√ìN: Mostrar Pok√©dex
// ============================================
function mostrarPokedex() {
    document.getElementById('description-section').style.display = 'block';
    document.getElementById('pokedex-timeline').style.display = 'block';
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

// ============================================
// 1Ô∏è‚É£6Ô∏è‚É£ FUNCI√ìN: Mostrar Juego (pr√≥ximamente)
// ============================================
function mostrarJuego() {
    document.getElementById('description-section').style.display = 'none';
    document.getElementById('pokedex-timeline').style.display = 'none';
    document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Pr√≥ximamente: aqu√≠ ir√° el contenido del juego
    alert('Secci√≥n de Juego - ¬°Pr√≥ximamente!');
}
